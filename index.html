<script>
  // ðŸ”‘ PUT YOUR GOOGLE MAPS API KEY BETWEEN THESE QUOTES:
  const GOOGLE_MAPS_API_KEY = 'AIzaSyDxSpOO_adV6pmCUpZjKKbPdEjy3ORdGxw';

  const form = document.getElementById('prrForm');
  const inputPanel = document.getElementById('input-panel');
  const reportPanel = document.getElementById('report-panel');
  const backToFormBtn = document.getElementById('backToForm');
  const printBtn = document.getElementById('printReport');

  function textVal(id) {
    const el = document.getElementById(id);
    return el && el.value ? el.value.trim() : '';
  }

  function mapSelectText(id) {
    const el = document.getElementById(id);
    if (!el) return '';
    const opt = el.options[el.selectedIndex];
    return opt && opt.text ? opt.text : '';
  }

  function fillText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || '';
  }

  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map((i) => i.value);
  }

  function buildPills(containerId, values, labelMap, isRisk) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    if (!values || values.length === 0) {
      const span = document.createElement('span');
      span.textContent = 'None recorded.';
      span.style.fontSize = '0.82rem';
      span.style.color = '#6b7280';
      container.appendChild(span);
      return;
    }
    values.forEach((v) => {
      const pill = document.createElement('div');
      pill.className = 'pill' + (isRisk ? ' negative' : '');
      pill.textContent = (labelMap && labelMap[v]) || v;
      container.appendChild(pill);
    });
  }

  const labelMaps = {
    designations: {
      conservation_area: 'Conservation area',
      green_belt: 'Green Belt',
      aonb: 'Area of Outstanding Natural Beauty',
      national_park: 'National Park',
      world_heritage_site: 'World Heritage Site',
      article_4: 'Article 4 Direction',
      flood_zone_1: 'Flood Zone 1',
      flood_zone_2: 'Flood Zone 2',
      flood_zone_3: 'Flood Zone 3',
      sssi: 'SSSI / SAC',
      listed_building: 'Listed building',
      locally_listed: 'Locally listed building',
      none: 'No special designations known',
    },
    constraints: {
      tpo: 'Protected trees (TPO)',
      hedgerows: 'Important hedgerows',
      right_of_way: 'Public right of way',
      contaminated: 'Contaminated land',
      noise: 'Noise (road/rail/industrial)',
      aqma: 'Air Quality Management Area',
      archaeology: 'Archaeological interest',
      heritage_sightlines: 'Heritage sightline constraints',
      unknown: 'Constraints unknown',
    },
    benefits: {
      better_accommodation: 'Better quality accommodation',
      visual_improvement: 'Visual/streetscene improvements',
      energy_efficiency: 'Energy / sustainability benefits',
      more_space: 'Additional internal floorspace',
      better_layout: 'Improved layout / accessibility',
      policy_support: 'Strong policy support',
    },
    risks: {
      overlooking: 'Overlooking / privacy',
      overshadowing: 'Overshadowing / daylight',
      bulk_scale: 'Bulk / scale / massing',
      heritage_harm: 'Heritage impact',
      green_belt_conflict: 'Green Belt conflict',
      parking_highways: 'Parking / highways issues',
      design_non_compliance: 'Design non-compliance',
      drainage_ecology: 'Drainage / ecology issues',
      neighbour_objections: 'Neighbour objections likely',
    },
  };

  // Pull "lat,lng" from a Google Maps / Street View URL if present
  function latLngFromGoogleUrl(url) {
    if (!url) return null;
    try {
      const m = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
      if (m) return m[1] + ',' + m[2];
    } catch (e) {}
    return null;
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const clientName = textVal('client_name');
    const siteAddress = textVal('site_address');
    const sitePostcode = textVal('site_postcode');
    const councilName = textVal('council_name');
    const existingUse = textVal('existing_use_class');
    const proposalSummary = textVal('proposal_summary');

    fillText('r_client_name', clientName || 'â€”');
    fillText('r_site_address', siteAddress);
    fillText('r_site_address_2', siteAddress);
    fillText('r_site_postcode', sitePostcode);
    fillText('r_council_name', councilName);
    fillText('r_council_name_2', councilName);
    fillText('r_existing_use_class', existingUse || 'Not specified');
    fillText('r_proposal_summary', proposalSummary || 'Not provided.');

    const siteTypeText = mapSelectText('site_type') || 'Not specified';
    const proposalTypeText = mapSelectText('proposal_type') || 'Not specified';
    fillText('r_site_type', siteTypeText);
    fillText('r_proposal_type', proposalTypeText);

    // Designations & constraints
    const designations = getCheckedValues('designations');
    const constraints = getCheckedValues('constraints');
    buildPills('r_designations', designations, labelMaps.designations, false);
    buildPills('r_constraints', constraints, labelMaps.constraints, false);

    // Context
    fillText('r_visibility_public', mapSelectText('visibility_public') || 'Not specified');
    fillText('r_privacy_impact', mapSelectText('privacy_impact') || 'Not specified');
    fillText('r_daylight_impact', mapSelectText('daylight_impact') || 'Not specified');

    // Design
    fillText('r_balcony', mapSelectText('balcony_presence') || 'Not specified');
    fillText('r_balcony_screening', mapSelectText('balcony_screening') || 'Not specified');
    fillText('r_height', mapSelectText('proposal_height') || 'Not specified');
    fillText('r_rear_projection', mapSelectText('rear_projection') || 'Not specified');
    fillText('r_materials', mapSelectText('materials') || 'Not specified');

    // Policy-level
    fillText('r_has_spd', mapSelectText('has_extension_spd') || 'Not specified');
    fillText('r_spd_compliance', mapSelectText('spd_compliance') || 'Not specified');
    fillText('r_parking_compliance', mapSelectText('parking_compliance') || 'Not specified');
    fillText('r_housing_mix_compliance', mapSelectText('housing_mix_compliance') || 'Not specified');
    fillText('r_nppf_sustainable', mapSelectText('nppf_sustainable') || 'Not specified');
    fillText('r_nppf_character', mapSelectText('nppf_characterscore') || 'Not specified');
    fillText('r_nppf_heritage', mapSelectText('nppf_heritage') || 'Not specified');

    // Policy 1
    const policy1Doc = textVal('policy1_doc_title');
    const policy1Authority = textVal('policy1_authority');
    let policy1DocCombined = '';
    if (policy1Doc && policy1Authority) {
      policy1DocCombined = policy1Doc + ' (' + policy1Authority + ')';
    } else {
      policy1DocCombined = policy1Doc || policy1Authority || 'Not specified';
    }
    fillText('r_policy1_doc', policy1DocCombined);
    fillText('r_policy1_ref', textVal('policy1_ref'));
    fillText('r_policy1_title', textVal('policy1_title'));
    fillText('r_policy1_quote', textVal('policy1_quote'));
    fillText('r_policy1_interp', textVal('policy1_interp'));

    // Policy 2
    const policy2Doc = textVal('policy2_doc_title');
    const policy2Authority = textVal('policy2_authority');
    const policy2Any = policy2Doc || policy2Authority || textVal('policy2_ref') || textVal('policy2_quote');
    const policy2Block = document.getElementById('r_policy2_block');
    if (policy2Any) {
      let policy2DocCombined = '';
      if (policy2Doc && policy2Authority) {
        policy2DocCombined = policy2Doc + ' (' + policy2Authority + ')';
      } else {
        policy2DocCombined = policy2Doc || policy2Authority || 'Not specified';
      }
      fillText('r_policy2_doc', policy2DocCombined);
      fillText('r_policy2_ref', textVal('policy2_ref'));
      fillText('r_policy2_title', textVal('policy2_title'));
      fillText('r_policy2_quote', textVal('policy2_quote'));
      fillText('r_policy2_interp', textVal('policy2_interp'));
      policy2Block.style.display = 'block';
    } else {
      policy2Block.style.display = 'none';
    }

    // Technical
    fillText('r_drainage_known', mapSelectText('drainage_known') || 'Not specified');
    fillText('r_suds_required', mapSelectText('suds_required') || 'Not specified');
    fillText('r_highways_safety', mapSelectText('highways_safety') || 'Not specified');
    fillText('r_ecology_risk', mapSelectText('ecology_risk') || 'Not specified');
    fillText('r_trees_impact', mapSelectText('trees_impact') || 'Not specified');

    // History & precedent
    fillText('r_hist1_ref', textVal('hist1_ref'));
    fillText('r_hist1_desc', textVal('hist1_desc'));
    fillText('r_hist1_decision', mapSelectText('hist1_decision') || 'Not specified');
    fillText('r_hist1_date', textVal('hist1_date') ? ' â€“ ' + textVal('hist1_date') : '');
    fillText('r_hist1_officer', textVal('hist1_officer') || 'Not summarised.');
    fillText('r_hist1_relevance', textVal('hist1_relevance') || 'Not explained.');

    fillText('r_prec1_address', textVal('prec1_address'));
    fillText('r_prec1_ref', textVal('prec1_ref'));
    fillText('r_prec1_desc', textVal('prec1_desc'));
    fillText('r_prec1_decision', mapSelectText('prec1_decision') || 'Not specified');
    fillText('r_prec1_relevance', textVal('prec1_relevance') || 'Not explained.');

    // Maps â€“ text URLs
    const mapsLocationUrl = textVal('maps_location_url');
    const mapsStreetViewUrl = textVal('maps_streetview_url');
    fillText('r_maps_location_url', mapsLocationUrl || 'Not provided');
    fillText('r_maps_streetview_url', mapsStreetViewUrl || 'Not provided');

    // Maps â€“ images (NOW DRIVEN BY LINKS ONLY)
    const staticMapImg = document.getElementById('r_static_map_img');
    const streetViewImg = document.getElementById('r_streetview_img');

    const hasKey = GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY.trim() !== '';
    if (hasKey && (mapsLocationUrl || mapsStreetViewUrl)) {
      // Try to get coordinates from the URLs
      const locLatLng = latLngFromGoogleUrl(mapsLocationUrl);
      const svLatLng = latLngFromGoogleUrl(mapsStreetViewUrl);

      // We require *some* lat,lng from at least one of the links
      const baseLatLng = locLatLng || svLatLng;

      if (baseLatLng) {
        const staticCenter = baseLatLng;
        const streetLocation = svLatLng || baseLatLng;

        const staticMapUrl =
          'https://maps.googleapis.com/maps/api/staticmap?center=' +
          encodeURIComponent(staticCenter) +
          '&zoom=18&size=640x360&maptype=satellite&markers=color:red|' +
          encodeURIComponent(staticCenter) +
          '&key=' +
          encodeURIComponent(GOOGLE_MAPS_API_KEY);

        const streetViewUrl =
          'https://maps.googleapis.com/maps/api/streetview?size=640x360&location=' +
          encodeURIComponent(streetLocation) +
          '&key=' +
          encodeURIComponent(GOOGLE_MAPS_API_KEY);

        staticMapImg.src = staticMapUrl;
        staticMapImg.alt = 'Site aerial map';
        streetViewImg.src = streetViewUrl;
        streetViewImg.alt = 'Site street view';
      } else {
        // Links present but no @lat,lng in them
        staticMapImg.removeAttribute('src');
        staticMapImg.alt = 'Static map not available â€“ use a full Google Maps URL that contains @lat,lng.';
        streetViewImg.removeAttribute('src');
        streetViewImg.alt = 'Street view not available â€“ use a full Street View URL that contains @lat,lng.';
      }
    } else {
      // No links or no key
      staticMapImg.removeAttribute('src');
      staticMapImg.alt = 'Static map not available â€“ add Google Maps and Street View URLs.';
      streetViewImg.removeAttribute('src');
      streetViewImg.alt = 'Street view not available â€“ add Google Maps and Street View URLs.';
    }

    // Planning balance
    const likelihoodValue = mapSelectText('likelihood');
    const likelihoodText = likelihoodValue
      ? likelihoodValue.charAt(0).toUpperCase() + likelihoodValue.slice(1)
      : 'Not specified';
    fillText('r_likelihood', likelihoodText);
    fillText('r_likelihood_inline', likelihoodText.toLowerCase());

    const benefits = getCheckedValues('benefits');
    const risks = getCheckedValues('risks');
    buildPills('r_benefits', benefits, labelMaps.benefits, false);
    buildPills('r_risks', risks, labelMaps.risks, true);

    const balanceText =
      textVal('balance_text') ||
      'A narrative planning balance has not been provided. This section should be completed before issuing to the client.';
    fillText('r_balance_text', balanceText);

    // Show report
    inputPanel.style.display = 'none';
    reportPanel.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  backToFormBtn.addEventListener('click', function () {
    reportPanel.style.display = 'none';
    inputPanel.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  printBtn.addEventListener('click', function () {
    window.print();
  });
</script>
